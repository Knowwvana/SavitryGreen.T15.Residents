<div class="d-flex flex-column h-100 bg-light">

    <div class="flex-grow-1 overflow-auto pb-5">

        <div class="bg-white p-3 shadow-sm rounded-bottom-4 border-bottom mb-3 position-relative">
            <div class="row g-0 align-items-start">

                <div class="col-5 border-end pe-2 d-flex flex-column">
                    <button class="btn btn-light btn-sm rounded-circle shadow-sm border mb-2 me-auto" 
                            @click="view = 'residents'" style="width: 32px; height: 32px;">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    
                    <h2 class="fw-bold text-dark mb-0 lh-1">
                        <span class="fs-6 text-muted fw-normal d-block mb-1">Flat</span>
                        <span x-text="activeResident.flat"></span>
                    </h2>
                    
                    <div class="mt-2 text-secondary small fw-medium">
                        <div class="d-flex align-items-center gap-1 mb-1">
                            <i class="bi bi-layers-fill text-primary"></i>
                            <span>Floor <span x-text="activeResident.floor"></span></span>
                        </div>
                        <div class="d-flex align-items-center gap-1">
                            <i class="bi bi-building-fill text-danger"></i>
                            <span>Tower <span x-text="activeResident.tower"></span></span>
                        </div>
                    </div>
                </div>

                <div class="col-7 ps-3">
                    <h6 class="text-secondary small fw-bold mb-2 text-uppercase">Resident(s) Details</h6>
                    
                    <div class="d-flex flex-column gap-2 overflow-auto" style="max-height: 220px;">
                        <template x-for="p in activeResident.occupants">
                            <div class="bg-light rounded-3 p-2 border w-100">
                                <div class="d-flex align-items-start gap-2 mb-1">
                                    <div class="flex-shrink-0 mt-1">
                                        <i class="bi" :class="p.type.toLowerCase() === 'owner' ? 'bi-house-fill text-success' : 'bi-person-fill text-warning'"></i>
                                    </div>
                                    <div>
                                        <span class="fw-bold small text-uppercase d-block lh-1 mb-1"
                                              :class="p.type.toLowerCase() === 'owner' ? 'text-success' : 'text-danger'"
                                              style="font-size: 0.65rem;" x-text="p.type"></span>
                                        <div class="fw-bold text-dark small text-wrap lh-sm" x-text="p.name"></div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-2 mt-2" x-show="p.phone">
                                    <div class="flex-shrink-0 text-center" style="width: 16px;">
                                        <i class="bi bi-phone-fill text-primary" style="font-size: 0.9rem;"></i>
                                    </div>
                                    <div class="small text-muted fw-medium flex-grow-1 text-break" x-text="p.phone"></div>
                                    <div class="d-flex gap-3 flex-shrink-0">
                                        <a :href="'tel:' + p.phone" class="text-primary text-decoration-none"><i class="bi bi-telephone-fill"></i></a>
                                        <a :href="'https://wa.me/91' + p.phone" class="text-success text-decoration-none"><i class="bi bi-whatsapp"></i></a>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-2 mt-1" x-show="p.email">
                                    <div class="flex-shrink-0 text-center" style="width: 16px;">
                                        <i class="bi bi-envelope-fill text-secondary" style="font-size: 0.9rem;"></i>
                                    </div>
                                    <div class="small text-muted fw-medium text-break flex-grow-1" style="font-size: 0.75rem; line-height: 1.2;" x-text="p.email"></div>
                                    <div class="flex-shrink-0">
                                        <a :href="'mailto:' + p.email" class="text-danger text-decoration-none"><i class="bi bi-envelope-at-fill"></i></a>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-3 mb-3">
             <div class="d-flex align-items-center gap-2 mb-2 ps-1">
                <i class="bi bi-pie-chart-fill text-dark"></i>
                <h6 class="fw-bold text-muted small text-uppercase mb-0">Payment History Summary</h6>
            </div>
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-body p-0 d-flex">
                    <div class="flex-fill p-2 border-end bg-success bg-opacity-10 d-flex align-items-center justify-content-center gap-2">
                        <div class="rounded-circle bg-white text-success d-flex align-items-center justify-content-center shadow-sm"
                            style="width: 32px; height: 32px;">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <div class="text-start">
                            <small class="d-block text-uppercase fw-bold text-muted lh-1"
                                style="font-size: 0.55rem;">Paid</small>
                            <div class="fw-bold text-dark small lh-1 mt-1"
                                x-text="'₹' + ((activeResident.stats || {}).totalPaid || 0).toLocaleString('en-IN')">
                            </div>
                        </div>
                    </div>
                    <div class="flex-fill p-2 border-end bg-warning bg-opacity-10 d-flex align-items-center justify-content-center gap-2">
                        <div class="rounded-circle bg-white text-warning d-flex align-items-center justify-content-center shadow-sm"
                            style="width: 32px; height: 32px;">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div class="text-start">
                            <small class="d-block text-uppercase fw-bold text-muted lh-1"
                                style="font-size: 0.55rem;">Pending</small>
                            <div class="fw-bold text-dark small lh-1 mt-1"
                                x-text="'₹' + ((activeResident.stats || {}).pendingValidation || 0).toLocaleString('en-IN')">
                            </div>
                        </div>
                    </div>
                    <div class="flex-fill p-2 bg-danger bg-opacity-10 d-flex align-items-center justify-content-center gap-2">
                        <div class="rounded-circle bg-white text-danger d-flex align-items-center justify-content-center shadow-sm"
                            style="width: 32px; height: 32px;">
                            <i class="bi bi-exclamation-circle-fill"></i>
                        </div>
                        <div class="text-start">
                            <small class="d-block text-uppercase fw-bold text-muted lh-1"
                                style="font-size: 0.55rem;">Due</small>
                            <div class="fw-bold text-dark small lh-1 mt-1"
                                x-text="'₹' + ((activeResident.stats || {}).currentDue || 0).toLocaleString('en-IN')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <template x-if="activeResident.pendingList && activeResident.pendingList.length > 0">
            <div class="px-3 mb-4">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-danger me-2 rounded-pill" style="width: 4px; height: 24px;"></div>
                    <h5 class="fw-bold text-dark mb-0">PENDING DUES</h5>
                </div>

                <div class="d-flex flex-column gap-3">
                    <template x-for="item in activeResident.pendingList">
                        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                            <div class="card-body p-3 d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="border border-danger border-opacity-25 text-danger rounded-3 p-2 me-3 d-flex align-items-center justify-content-center"
                                        style="width: 45px; height: 45px;">
                                        <i class="bi bi-calendar-x fs-4"></i>
                                    </div>
                                    <div>
                                        <h6 class="fw-bold text-dark mb-0" style="font-size: 1rem;" x-text="item.label">
                                        </h6>
                                        <small class="text-muted" style="font-size: 0.75rem;">Monthly
                                            Maintenance</small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="text-danger fw-bold fs-6 me-1" x-text="'₹' + item.amount"></span>
                                    <button class="btn btn-primary rounded-pill px-3 py-1 fw-bold shadow-sm"
                                        style="font-size: 0.85rem;"
                                        @click="payPending(item.value, item.amount)">Pay</button>
                                    <button
                                        class="btn btn-light rounded-circle border shadow-sm d-flex align-items-center justify-content-center"
                                        style="width: 32px; height: 32px;"
                                        @click="payPending(item.value, item.amount)"><i
                                            class="bi bi-pencil-fill text-muted"
                                            style="font-size: 0.7rem;"></i></button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <div class="p-3 sticky-top bg-light" style="top: 0px; z-index: 1000;">
            <div class="position-relative shadow-sm rounded-pill">
                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                <input type="text" x-model="historyQuery" @input="pageM = 1; pageA = 1"
                    class="form-control border-0 rounded-pill ps-5 py-2" placeholder="Search month, amount, remarks...">
            </div>
        </div>

        <div class="px-3 mb-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <div class="bg-primary me-2 rounded-pill" style="width: 4px; height: 24px;"></div>
                    <i class="bi bi-calendar-week-fill text-primary me-2 fs-5"></i>
                    <h5 class="fw-bold text-dark mb-0">MONTHLY PAYMENTS</h5>
                </div>
                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill"
                    x-text="filteredMonthly.length + ' Total'"></span>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-primary bg-opacity-10">
                <div class="card-body p-0 bg-white m-1 rounded-4">

                    <template x-for="txn in paginatedMonthly" :key="txn.id">
                        <div class="border-bottom" x-data="{ expanded: false }">

                            <div class="p-3 d-flex align-items-center justify-content-between cursor-pointer hover-bg-light transition-all"
                                @click="expanded = !expanded" style="cursor: pointer;">

                                <div class="d-flex align-items-center gap-3 w-100">
                                    <div class="rounded-circle bg-primary bg-opacity-10 text-primary d-flex align-items-center justify-content-center flex-shrink-0"
                                        style="width: 42px; height: 42px;">
                                        <i class="bi bi-calendar-check-fill fs-5"></i>
                                    </div>

                                    <div class="flex-grow-1" style="min-width: 0;">
                                        <h6 class="fw-bold text-dark mb-0" style="font-size: 0.95rem;"
                                            x-text="new Date(txn.rawMonth || txn.rawDate).toLocaleDateString('en-GB', {month: 'long', year: 'numeric'})">
                                        </h6>
                                        <div class="text-muted small d-flex align-items-center mt-1">
                                            <span
                                                x-text="new Date(txn.rawDate).toLocaleString('en-GB', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true}).toUpperCase()"
                                                style="font-size: 0.75rem;"></span>
                                        </div>
                                    </div>

                                    <div class="text-end flex-shrink-0">
                                        <div class="d-flex align-items-center justify-content-end gap-2 mb-1">
                                            <div class="text-secondary opacity-75">
                                                <template x-if="(txn.method || '').toLowerCase().includes('upi')">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg"
                                                        alt="UPI" style="height: 14px; width: auto; opacity: 0.8;">
                                                </template>
                                                <template x-if="!(txn.method || '').toLowerCase().includes('upi')">
                                                    <i class="bi"
                                                        :class="(txn.method || '').toLowerCase().includes('cash') ? 'bi-cash-stack' : 'bi-credit-card-2-front-fill'"
                                                        style="font-size: 1.1rem;"></i>
                                                </template>
                                            </div>
                                            <h5 class="fw-bold text-success mb-0" x-text="'₹' + txn.amount"></h5>
                                        </div>

                                        <div class="d-flex align-items-center justify-content-end gap-2">
                                            
                                            <div x-show="txn.validatedBy && txn.status.toLowerCase() === 'paid'"
                                                class="text-success d-flex align-items-center gap-1 small lh-1"
                                                style="font-size: 0.65rem;">
                                                <i class="bi bi-shield-fill-check"></i>
                                                <span x-text="'Approved by ' + txn.validatedBy"></span>
                                            </div>

                                            <span class="badge rounded-pill d-inline-flex align-items-center gap-1"
                                                :class="txn.status.toLowerCase() === 'paid' ? 'bg-success' : 'bg-warning text-dark'"
                                                style="font-size: 0.6rem;">
                                                <i class="bi"
                                                    :class="txn.status.toLowerCase() === 'paid' ? 'bi-check-circle-fill' : 'bi-hourglass-split'"></i>
                                                <span x-text="txn.status"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div x-show="expanded && txn.remarks" x-collapse class="bg-light bg-opacity-50 border-top">
                                <div class="p-3">
                                    <div class="d-flex gap-2 text-muted small bg-white rounded p-2 border shadow-sm">
                                        <i class="bi bi-chat-quote-fill text-warning flex-shrink-0"
                                            style="font-size: 0.9rem;"></i>
                                        <div>
                                            <span class="fw-bold text-dark d-block mb-1"
                                                style="font-size: 0.7rem;">COMMENTS:</span>
                                            <span class="fst-italic text-break"
                                                style="font-size: 0.8rem; line-height: 1.4;"
                                                x-text="txn.remarks"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </template>

                    <div x-show="filteredMonthly.length === 0" class="p-4 text-center text-muted small">No matching
                        monthly payments.</div>

                    <div class="p-2 bg-light border-top d-flex justify-content-between align-items-center"
                        x-show="filteredMonthly.length > limit">
                        <button class="btn btn-sm btn-white border shadow-sm rounded-circle" :disabled="pageM === 1"
                            @click="pageM--"><i class="bi bi-chevron-left"></i></button>
                        <span class="small fw-bold text-muted">Page <span x-text="pageM"></span> of <span
                                x-text="totalPagesM"></span></span>
                        <button class="btn btn-sm btn-white border shadow-sm rounded-circle"
                            :disabled="pageM === totalPagesM" @click="pageM++"><i
                                class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-3 mb-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <div class="bg-warning me-2 rounded-pill" style="width: 4px; height: 24px;"></div>
                    <i class="bi bi-stars text-warning me-2 fs-5"></i>
                    <h5 class="fw-bold text-dark mb-0">ADHOC / OTHER PAYMENTS</h5>
                </div>
                <span class="badge bg-warning bg-opacity-10 text-dark rounded-pill"
                    x-text="filteredAdhoc.length + ' Total'"></span>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-warning bg-opacity-10">
                <div class="card-body p-0 bg-white m-1 rounded-4">

                    <template x-for="txn in paginatedAdhoc" :key="txn.id">
                        <div class="border-bottom" x-data="{ expanded: false }">

                            <div class="p-3 d-flex align-items-center justify-content-between cursor-pointer hover-bg-light transition-all"
                                @click="expanded = !expanded" style="cursor: pointer;">

                                <div class="d-flex align-items-center gap-3 w-100">
                                    <div class="rounded-circle bg-warning bg-opacity-10 text-warning d-flex align-items-center justify-content-center flex-shrink-0"
                                        style="width: 40px; height: 40px;">
                                        <i class="bi bi-star-fill fs-5"></i>
                                    </div>

                                    <div class="flex-grow-1" style="min-width: 0;">
                                        <h6 class="fw-bold text-dark mb-0 text-break" style="font-size: 0.9rem;"
                                            x-text="txn.title || txn.category"></h6>
                                        <div class="text-muted small d-flex align-items-center mt-1">
                                            <span
                                                x-text="new Date(txn.rawDate).toLocaleString('en-GB', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true}).toUpperCase()"
                                                style="font-size: 0.75rem;"></span>
                                        </div>
                                    </div>

                                    <div class="text-end flex-shrink-0">
                                        <div class="d-flex align-items-center justify-content-end gap-2 mb-1">
                                            <div class="text-secondary opacity-75">
                                                <template x-if="(txn.method || '').toLowerCase().includes('upi')">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg"
                                                        alt="UPI" style="height: 14px; width: auto; opacity: 0.8;">
                                                </template>
                                                <template x-if="!(txn.method || '').toLowerCase().includes('upi')">
                                                    <i class="bi"
                                                        :class="(txn.method || '').toLowerCase().includes('cash') ? 'bi-cash-stack' : 'bi-credit-card-2-front-fill'"
                                                        style="font-size: 1.1rem;"></i>
                                                </template>
                                            </div>
                                            <h5 class="fw-bold text-success mb-0" x-text="'₹' + txn.amount"></h5>
                                        </div>

                                        <div class="d-flex align-items-center justify-content-end gap-2">
                                            
                                            <div x-show="txn.validatedBy && txn.status.toLowerCase() === 'paid'"
                                                class="text-success d-flex align-items-center gap-1 small lh-1"
                                                style="font-size: 0.65rem;">
                                                <i class="bi bi-shield-fill-check"></i>
                                                <span x-text="'Approved by ' + txn.validatedBy"></span>
                                            </div>

                                            <span class="badge rounded-pill d-inline-flex align-items-center gap-1"
                                                :class="txn.status.toLowerCase() === 'paid' ? 'bg-success' : 'bg-warning text-dark'"
                                                style="font-size: 0.6rem;">
                                                <i class="bi"
                                                    :class="txn.status.toLowerCase() === 'paid' ? 'bi-check-circle-fill' : 'bi-hourglass-split'"></i>
                                                <span x-text="txn.status"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div x-show="expanded && txn.remarks" x-collapse class="bg-light bg-opacity-50 border-top">
                                <div class="p-3">
                                    <div class="d-flex gap-2 text-muted small bg-white rounded p-2 border shadow-sm">
                                        <i class="bi bi-chat-quote-fill text-warning flex-shrink-0"
                                            style="font-size: 0.9rem;"></i>
                                        <div>
                                            <span class="fw-bold text-dark d-block mb-1"
                                                style="font-size: 0.7rem;">COMMENTS:</span>
                                            <span class="fst-italic text-break"
                                                style="font-size: 0.8rem; line-height: 1.4;"
                                                x-text="txn.remarks"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="filteredAdhoc.length === 0" class="p-4 text-center text-muted small">No matching adhoc
                        payments.</div>

                    <div class="p-2 bg-light border-top d-flex justify-content-between align-items-center"
                        x-show="filteredAdhoc.length > limit">
                        <button class="btn btn-sm btn-white border shadow-sm rounded-circle" :disabled="pageA === 1"
                            @click="pageA--"><i class="bi bi-chevron-left"></i></button>
                        <span class="small fw-bold text-muted">Page <span x-text="pageA"></span> of <span
                                x-text="totalPagesA"></span></span>
                        <button class="btn btn-sm btn-white border shadow-sm rounded-circle"
                            :disabled="pageA === totalPagesA" @click="pageA++"><i
                                class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>