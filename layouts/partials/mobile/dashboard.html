<template x-if="isLoading">
    <div class="p-3" style="margin-top: -50px; position: relative; z-index: 2;">
        <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white">
            <div class="card-body p-4">
                <div class="skeleton-box mb-4" style="width: 100%; height: 20px;"></div>
                <div class="skeleton-box mb-4" style="width: 100%; height: 40px;"></div>
                <div class="skeleton-box mb-2" style="width: 100%; height: 40px;"></div>
            </div>
        </div>
    </div>
</template>

<template x-if="!isLoading">
    <div class="p-3 pb-5" style="margin-top: 5px; position: relative; z-index: 2;">

        <div class="card border-0 shadow-sm rounded-4 mb-3 bg-white overflow-hidden">
            <div class="bg-primary bg-opacity-10 border-bottom py-2 px-3 d-flex align-items-center gap-2">
                <i class="bi bi-building-fill text-primary"></i>
                <span class="text-primary fw-bold small text-uppercase" style="letter-spacing: 1px;">Monthly Maintenance</span>
            </div>

            <div class="p-3">
                <div class="row g-2 mb-3 text-center">
                    <div class="col-4 border-end">
                        <small class="text-muted fw-bold text-uppercase d-block mb-1" style="font-size: 0.55rem;">Collected</small>
                        <div class="fw-bold text-dark small" x-text="'₹' + dashboardStats.monthlyTotal.toLocaleString('en-IN')"></div>
                    </div>
                    <div class="col-4 border-end">
                        <small class="text-muted fw-bold text-uppercase d-block mb-1" style="font-size: 0.55rem;">Spent</small>
                        <div class="fw-bold text-danger small" x-text="'₹' + dashboardStats.monthlySpent.toLocaleString('en-IN')"></div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted fw-bold text-uppercase d-block mb-1" style="font-size: 0.55rem;">Balance</small>
                        <div class="fw-bold text-success small" x-text="'₹' + dashboardStats.monthlyCashInHand.toLocaleString('en-IN')"></div>
                    </div>
                </div>

                <hr class="border-light my-2">

                <div class="row g-0">
                    
                    <div class="col-6 border-end pe-2">
                        <div class="text-center mb-2">
                            <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-2 py-1">
                                <i class="bi bi-arrow-down-circle-fill me-1"></i>Collections
                            </span>
                        </div>
                        <div class="d-flex justify-content-between px-2 mb-1 bg-light rounded py-1">
                            <small class="fw-bold text-muted text-uppercase" style="font-size: 0.5rem;">Month</small>
                            <small class="fw-bold text-muted text-uppercase" style="font-size: 0.5rem;">Amount</small>
                        </div>
                        <div class="d-flex flex-column gap-1">
                            <template x-for="m in dashboardStats.monthlyBreakdown">
                                <div class="d-flex justify-content-between align-items-center pb-1 border-bottom border-light last:border-0 px-1">
                                    <div class="d-flex align-items-center gap-1">
                                        <i class="bi bi-calendar-check-fill text-success" style="font-size: 0.6rem;"></i>
                                        <span class="fw-bold text-dark small" style="font-size: 0.65rem;" x-text="m.label"></span>
                                    </div>
                                    <span class="fw-bold text-success" style="font-size: 0.65rem;" x-text="'₹' + m.amount.toLocaleString('en-IN')"></span>
                                </div>
                            </template>
                            <div x-show="dashboardStats.monthlyBreakdown.length === 0" class="text-muted small fst-italic text-center" style="font-size: 0.6rem;">No collections</div>
                        </div>
                    </div>

                    <div class="col-6 ps-2">
                        <div class="text-center mb-2">
                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill px-2 py-1">
                                <i class="bi bi-arrow-up-circle-fill me-1"></i>Expenditure
                            </span>
                        </div>
                        <div class="row g-0 px-1 mb-1 bg-light rounded py-1">
                            <div class="col-5"><small class="fw-bold text-muted text-uppercase d-block" style="font-size: 0.5rem;">Title</small></div>
                            <div class="col-3 text-center"><small class="fw-bold text-muted text-uppercase d-block" style="font-size: 0.5rem;">Date</small></div>
                            <div class="col-4 text-end"><small class="fw-bold text-muted text-uppercase d-block" style="font-size: 0.5rem;">Amt</small></div>
                        </div>
                        <div class="d-flex flex-column gap-1">
                            <template x-for="exp in dashboardStats.monthlyExpenditureBreakdown">
                                <div class="row g-0 align-items-center pb-1 border-bottom border-light px-1">
                                    <div class="col-5 fw-bold text-dark text-truncate" style="font-size: 0.65rem;" x-text="exp.category"></div>
                                    <div class="col-3 text-center text-muted small" style="font-size: 0.55rem;" x-text="exp.date"></div>
                                    <div class="col-4 text-end fw-bold text-danger" style="font-size: 0.65rem;" x-text="'₹' + exp.amount.toLocaleString('en-IN')"></div>
                                </div>
                            </template>
                            <div x-show="dashboardStats.monthlyExpenditureBreakdown.length === 0" class="text-muted small fst-italic text-center" style="font-size: 0.6rem;">No expenditure records</div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white overflow-hidden">
            <div class="bg-warning bg-opacity-10 border-bottom py-2 px-3 d-flex align-items-center gap-2">
                <i class="bi bi-stars text-warning"></i>
                <span class="text-warning text-dark fw-bold small text-uppercase" style="letter-spacing: 1px;">Adhoc Event Summary</span>
            </div>

            <div class="p-3">
                <div class="row g-2 mb-3 text-center">
                    <div class="col-4 border-end">
                        <small class="text-muted fw-bold text-uppercase d-block mb-1" style="font-size: 0.55rem;">Collected</small>
                        <div class="fw-bold text-dark small" x-text="'₹' + dashboardStats.adhocTotal.toLocaleString('en-IN')"></div>
                    </div>
                    <div class="col-4 border-end">
                        <small class="text-muted fw-bold text-uppercase d-block mb-1" style="font-size: 0.55rem;">Spent</small>
                        <div class="fw-bold text-danger small" x-text="'₹' + dashboardStats.adhocSpent.toLocaleString('en-IN')"></div>
                    </div>
                    <div class="col-4">
                        <small class="text-muted fw-bold text-uppercase d-block mb-1" style="font-size: 0.55rem;">Balance</small>
                        <div class="fw-bold text-success small" x-text="'₹' + dashboardStats.adhocCashInHand.toLocaleString('en-IN')"></div>
                    </div>
                </div>

                <hr class="border-light my-2">

                <div>
                     <div class="row g-0 bg-light rounded py-1 px-1 mb-1">
                        <div class="col-3"><small class="fw-bold text-muted text-uppercase d-block" style="font-size: 0.65rem;">Purpose</small></div>
                        <div class="col-3 text-center"><small class="fw-bold text-muted text-uppercase d-block" style="font-size: 0.65rem;">Date</small></div>
                        <div class="col-2 text-end"><small class="fw-bold text-muted text-uppercase d-block" style="font-size: 0.65rem;">Collection</small></div>
                        <div class="col-2 text-end"><small class="fw-bold text-muted text-uppercase d-block" style="font-size: 0.65rem;">Expenses</small></div>
                        <div class="col-2 text-end"><small class="fw-bold text-muted text-uppercase d-block" style="font-size: 0.65rem;">Balance</small></div>
                    </div>

                    <div class="d-flex flex-column gap-1">
                        <template x-for="event in dashboardStats.adhocBreakdown">
                            <div class="row g-0 align-items-center pb-1 border-bottom border-light px-1">
                                <div class="col-3 d-flex align-items-center gap-1 overflow-hidden">
                                    <i class="bi bi-tag-fill text-warning flex-shrink-0" style="font-size: 0.65rem;"></i>
                                    <div class="fw-bold text-dark text-wrap small" style="font-size: 0.75rem; line-height: 1.1;" x-text="event.title"></div>
                                </div>
                                <div class="col-3 text-center text-muted small" style="font-size: 0.7rem;" x-text="event.date"></div>
                                <div class="col-2 text-end fw-bold text-dark" style="font-size: 0.75rem;" x-text="'₹' + event.collected.toLocaleString('en-IN')"></div>
                                <div class="col-2 text-end fw-bold text-danger" style="font-size: 0.75rem;" x-text="'₹' + event.spent.toLocaleString('en-IN')"></div>
                                <div class="col-2 text-end fw-bold" 
                                     :class="event.balance >= 0 ? 'text-success' : 'text-danger'" 
                                     style="font-size: 0.75rem;" 
                                     x-text="'₹' + event.balance.toLocaleString('en-IN')"></div>
                            </div>
                        </template>

                        <div x-show="dashboardStats.adhocBreakdown.length === 0" class="text-center text-muted small fst-italic py-2">
                            No adhoc events found
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden bg-warning bg-opacity-10 cursor-pointer" 
             x-show="dashboardStats.pendingValidationTotal > 0"
             @click="view = 'validate'" 
             style="cursor: pointer;">
            <div class="card-body p-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-white text-warning rounded-circle d-flex align-items-center justify-content-center shadow-sm" style="width: 35px; height: 35px;">
                         <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div style="line-height: 1.2;">
                        <span class="d-block fw-bold text-dark small">Pending Validation</span>
                        <small class="text-muted" style="font-size: 0.65rem;">Tap to review</small>
                    </div>
                </div>
                <span class="fw-bold text-dark h6 mb-0" x-text="'₹' + dashboardStats.pendingValidationTotal.toLocaleString('en-IN')"></span>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-end mb-2 px-1">
            <h6 class="fw-bold text-dark mb-0">Recent Activity</h6>
            <button class="btn btn-link text-decoration-none small fw-bold p-0" @click.prevent="view = 'residents'" style="font-size: 0.75rem;">View All</button>
        </div>

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white">
            <div class="list-group list-group-flush">
                <template x-for="(txn, index) in dashboardStats.recentTransactions" :key="txn.id">
                    <div class="list-group-item p-3 border-light position-relative" 
                            @click="openResidentByFlat(txn.flatNo)"
                            style="cursor: pointer;">
                        
                        <div class="position-absolute top-0 start-0 bottom-0" 
                                :class="index % 2 === 0 ? 'bg-primary' : 'bg-info'"
                                style="width: 4px;"></div>

                        <div class="d-flex justify-content-between align-items-center ps-2">
                            <div class="d-flex align-items-start gap-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 mt-1" 
                                        style="width: 40px; height: 40px;"
                                        :class="txn.isMonthly ? 'bg-success bg-opacity-10 text-success' : 'bg-warning bg-opacity-10 text-warning'">
                                    <i class="bi fs-5" :class="txn.isMonthly ? 'bi-wallet-fill' : 'bi-cash-stack'"></i>
                                </div>
                                
                                <div class="d-flex flex-column">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-bold text-dark small" style="font-size: 0.9rem;">
                                            <span x-text="(!txn.isMonthly && txn.title) ? txn.title : txn.type"></span>
                                            <span x-show="txn.isMonthly"> - <span x-text="txn.displayPaymentFor.replace(' ', '-')"></span></span>
                                        </span>
                                    </div>

                                    <div class="text-dark small fw-medium mt-0 d-flex align-items-center" style="font-size: 0.75rem;">
                                        <span class="fw-bold">Flat <span x-text="txn.displayFlat"></span></span>
                                        <span x-show="txn.displayResidentName !== 'Unknown'" class="mx-1 opacity-50">|</span>
                                        <span x-show="txn.displayResidentName !== 'Unknown'" x-text="txn.displayResidentName" class="text-truncate" style="max-width: 120px;"></span>
                                    </div>
                                    
                                    <div class="text-muted small mt-1 d-flex align-items-center gap-2" style="font-size: 0.7rem;">
                                        <span x-text="txn.fullDateTime"></span>
                                        <span class="badge bg-light text-secondary border px-1" style="font-size: 0.6rem;" x-text="txn.method"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-end">
                                <div class="fw-bold text-success" style="font-size: 0.95rem;" x-text="'+ ₹' + txn.amount"></div>
                                <span class="badge rounded-pill mt-1" 
                                        :class="txn.status.toLowerCase() === 'paid' ? 'bg-success' : 'bg-warning text-dark'" 
                                        style="font-size: 0.6rem;" x-text="txn.status"></span>
                            </div>
                        </div>
                    </div>
                </template>
                
                <template x-if="dashboardStats.recentTransactions.length === 0">
                    <div class="p-4 text-center text-muted small">
                        No recent transactions found
                    </div>
                </template>
            </div>
        </div>
    </div>
</template>