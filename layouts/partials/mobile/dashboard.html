<!-- 1. LOADING STATE -->
<template x-if="isLoading">
    <div class="min-vh-100 bg-white">
        <!-- Skeleton Header -->
        <div class="position-relative bg-dark shadow-sm overflow-hidden" 
             style="min-height: 220px; border-bottom-left-radius: 2rem; border-bottom-right-radius: 2rem;">
            <div class="p-4 d-flex flex-column h-100 justify-content-between">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="skeleton-box skeleton-dark rounded-circle" style="width: 32px; height: 32px;"></div>
                    <div class="skeleton-box skeleton-dark rounded-pill" style="width: 100px; height: 32px;"></div>
                </div>
                <div>
                    <div class="skeleton-box skeleton-dark mb-2" style="width: 60%; height: 28px;"></div>
                    <div class="skeleton-box skeleton-dark mb-4" style="width: 40%; height: 16px;"></div>
                </div>
            </div>
        </div>

        <!-- Skeleton Content -->
        <div class="p-3" style="margin-top: -50px; position: relative; z-index: 2;">
            <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white">
                <div class="card-body p-4">
                    <div class="skeleton-box mb-4" style="width: 100%; height: 60px;"></div>
                    <div class="skeleton-box mb-2" style="width: 100%; height: 30px;"></div>
                    <div class="skeleton-box mb-2" style="width: 100%; height: 30px;"></div>
                    <div class="skeleton-box mb-2" style="width: 100%; height: 30px;"></div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- 2. DATA LOADED STATE -->
<template x-if="!isLoading">
    <div>
        <!-- HEADER BANNER -->
        <div class="position-relative bg-dark text-white shadow-sm overflow-hidden" 
             style="min-height: 220px; border-bottom-left-radius: 2rem; border-bottom-right-radius: 2rem;">
            
            <!-- Background Image -->
            <div class="position-absolute top-0 start-0 w-100 h-100" 
                 style="background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(51, 65, 85, 0.8) 100%), url('https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?auto=format&fit=crop&q=80'); background-size: cover; background-position: center; z-index: 0;">
            </div>

            <!-- Content -->
            <div class="position-relative p-4 d-flex flex-column h-100 justify-content-between" style="z-index: 1;">
                
                <!-- Top Row -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center gap-2">
                        <div class="bg-success bg-opacity-25 rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                            <i class="bi bi-building text-white"></i>
                        </div>
                        <small class="fw-medium text-white-50" style="letter-spacing: 0.5px;" x-text="currentDate"></small>
                    </div>
                    <button class="btn btn-sm btn-light rounded-pill px-3 fw-bold shadow-sm" @click="view = 'add'">
                        <i class="bi bi-plus-lg me-1"></i> New Entry
                    </button>
                </div>

                <!-- Society Info -->
                <div class="mb-4">
                    <h2 class="fw-bold mb-1" x-text="settings.SocietyName || 'Loading...'"></h2>
                    <div class="d-flex align-items-center text-white-50 small">
                        <i class="bi bi-geo-alt-fill me-2 text-warning"></i>
                        <span x-text="settings.SocietyAddress || ''"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="p-3 pb-5" style="margin-top: -60px; position: relative; z-index: 2;">

            <!-- FINANCIAL DASHBOARD (HIERARCHY LIST) -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white overflow-hidden">
                <div class="card-body p-0">
                    
                    <!-- 1. Top Totals Row -->
                    <div class="p-4 bg-light bg-gradient border-bottom">
                        <div class="row g-3 text-center">
                             <div class="col-4 border-end">
                                <small class="text-muted text-uppercase fw-bold d-block mb-1" style="font-size: 0.6rem;">Total Collected</small>
                                <h5 class="fw-bold text-success mb-0" x-text="'₹' + dashboardStats.totalCollection.toLocaleString('en-IN')"></h5>
                             </div>
                             <div class="col-4 border-end">
                                <small class="text-muted text-uppercase fw-bold d-block mb-1" style="font-size: 0.6rem;">Total Spent</small>
                                <h5 class="fw-bold text-danger mb-0">₹0</h5>
                             </div>
                             <div class="col-4">
                                <small class="text-muted text-uppercase fw-bold d-block mb-1" style="font-size: 0.6rem;">Cash in Hand</small>
                                <h5 class="fw-bold text-primary mb-0">₹0</h5>
                             </div>
                        </div>
                    </div>

                    <!-- 2. Breakdown List -->
                    <div class="list-group list-group-flush">
                        
                        <!-- SECTION 1: By Category -->
                        <div class="list-group-item p-4 border-light">
                            <div class="d-flex align-items-center mb-3">
                                <span class="text-muted small fw-bold text-uppercase">By Category</span>
                            </div>
                            
                            <!-- Monthly Maintenance -->
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="d-flex align-items-center">
                                         <i class="bi bi-building text-primary me-2"></i>
                                         <span class="text-dark fw-bold">Monthly Maintenance (Total)</span>
                                    </div>
                                    <span class="fw-bold text-dark" x-text="'₹' + dashboardStats.monthlyTotal.toLocaleString('en-IN')"></span>
                                </div>
                                <div class="ps-4 ms-1 border-start border-2 border-light">
                                    <!-- Current -->
                                    <div class="d-flex justify-content-between align-items-center small mt-1 ps-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-check-fill text-success me-2"></i>
                                            <span class="text-muted" x-text="dashboardStats.currentMonthLabel"></span>
                                        </div>
                                        <span class="fw-bold text-secondary" x-text="'₹' + dashboardStats.monthlyCurrent.toLocaleString('en-IN')"></span>
                                    </div>
                                    <!-- Last -->
                                    <div class="d-flex justify-content-between align-items-center small mt-1 ps-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-event-fill text-info me-2"></i>
                                            <span class="text-muted" x-text="dashboardStats.lastMonthLabel"></span>
                                        </div>
                                        <span class="fw-bold text-secondary" x-text="'₹' + dashboardStats.monthlyLast.toLocaleString('en-IN')"></span>
                                    </div>
                                    <!-- Prev Prev -->
                                     <div class="d-flex justify-content-between align-items-center small mt-1 ps-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-week-fill text-warning me-2"></i>
                                            <span class="text-muted" x-text="dashboardStats.prevPrevMonthLabel"></span>
                                        </div>
                                        <span class="fw-bold text-secondary" x-text="'₹' + dashboardStats.monthlyPrevPrev.toLocaleString('en-IN')"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Adhoc -->
                            <div>
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="d-flex align-items-center">
                                         <i class="bi bi-stars text-warning me-2"></i>
                                         <span class="text-dark fw-bold">Adhoc / Other (Total)</span>
                                    </div>
                                    <span class="fw-bold text-info" x-text="'₹' + dashboardStats.adhocTotal.toLocaleString('en-IN')"></span>
                                </div>
                                <div class="ps-4 ms-1 border-start border-2 border-light">
                                    <div class="d-flex justify-content-between align-items-center small mt-1 ps-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-check-fill text-success me-2"></i>
                                            <span class="text-muted" x-text="dashboardStats.currentMonthLabel"></span>
                                        </div>
                                        <span class="fw-bold text-secondary" x-text="'₹' + dashboardStats.adhocCurrent.toLocaleString('en-IN')"></span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center small mt-1 ps-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-event-fill text-info me-2"></i>
                                            <span class="text-muted" x-text="dashboardStats.lastMonthLabel"></span>
                                        </div>
                                        <span class="fw-bold text-secondary" x-text="'₹' + dashboardStats.adhocLast.toLocaleString('en-IN')"></span>
                                    </div>
                                     <div class="d-flex justify-content-between align-items-center small mt-1 ps-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-calendar-week-fill text-warning me-2"></i>
                                            <span class="text-muted" x-text="dashboardStats.prevPrevMonthLabel"></span>
                                        </div>
                                        <span class="fw-bold text-secondary" x-text="'₹' + dashboardStats.adhocPrevPrev.toLocaleString('en-IN')"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 2: Recent Payments -->
                        <div class="list-group-item p-4 border-light">
                            <div class="d-flex align-items-center mb-3">
                                <span class="text-muted small fw-bold text-uppercase">Recent Payments(s)</span>
                            </div>
                            <div class="ps-3 border-start border-2 border-warning ms-1">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-dark small">This Week</span>
                                    <span class="fw-bold text-dark" x-text="'₹' + dashboardStats.receivedThisWeek.toLocaleString('en-IN')"></span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-dark small">This Month</span>
                                    <span class="fw-bold text-dark" x-text="'₹' + dashboardStats.receivedThisMonth.toLocaleString('en-IN')"></span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-dark small">Last Month</span>
                                    <span class="fw-bold text-dark" x-text="'₹' + dashboardStats.receivedLastMonth.toLocaleString('en-IN')"></span>
                                </div>
                                 <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-dark small">Month Before</span>
                                    <span class="fw-bold text-dark" x-text="'₹' + dashboardStats.receivedPrevPrevMonth.toLocaleString('en-IN')"></span>
                                </div>
                            </div>
                        </div>

                        <!-- SECTION 3: Pending Validation -->
                        <div class="list-group-item p-4 border-light bg-warning bg-opacity-10 cursor-pointer" @click="view = 'validate'" style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="d-block fw-bold text-dark mb-1">Pending Validation(s)</span>
                                </div>
                                <span class="fw-bold text-dark h4 mb-0" x-text="'₹' + dashboardStats.pendingValidationTotal.toLocaleString('en-IN')"></span>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Recent Transactions Header -->
            <div class="d-flex justify-content-between align-items-end mb-3 px-1">
                <h6 class="fw-bold text-dark mb-0">Recent Transactions (50)</h6>
                <button class="btn btn-link text-decoration-none small fw-bold p-0" @click.prevent="view = 'residents'">View All</button>
            </div>

            <!-- Transactions List -->
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="list-group list-group-flush">
                    <template x-for="(txn, index) in dashboardStats.recentTransactions" :key="txn.id">
                        <div class="list-group-item p-3 border-light position-relative" 
                             @click="openResidentByFlat(txn.flatNo)"
                             style="cursor: pointer; transition: background-color 0.2s;">
                            
                            <!-- Left Color Line -->
                            <div class="position-absolute top-0 start-0 bottom-0" 
                                 :class="index % 2 === 0 ? 'bg-primary' : 'bg-info'"
                                 style="width: 4px;"></div>

                            <div class="d-flex justify-content-between align-items-center ps-2">
                                <div class="d-flex align-items-start gap-3">
                                    <!-- Dynamic Icon -->
                                    <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 mt-1" 
                                         style="width: 45px; height: 45px;"
                                         :class="txn.isMonthly ? 'bg-success bg-opacity-10 text-success' : 'bg-warning bg-opacity-10 text-warning'">
                                        <i class="bi fs-5" :class="txn.isMonthly ? 'bi-wallet-fill' : 'bi-cash-stack'"></i>
                                    </div>
                                    
                                    <div class="d-flex flex-column">
                                        <!-- Line 1: Type -->
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="fw-bold text-dark" style="font-size: 0.95rem;">
                                                <span x-text="txn.type"></span>
                                                <span x-show="txn.isMonthly"> - <span x-text="txn.displayPaymentFor.replace(' ', '-')"></span></span>
                                            </span>
                                            <!-- Method Badge -->
                                            <span class="badge bg-light text-secondary border px-2 py-1 d-flex align-items-center gap-1" style="font-size: 0.65rem;">
                                                <i class="bi bi-phone-flip" style="font-size: 0.7rem;"></i>
                                                <span x-text="txn.method"></span>
                                            </span>
                                        </div>

                                        <!-- Line 2: Flat + Name -->
                                        <div class="text-dark small fw-medium mt-1 d-flex align-items-center">
                                            <i class="bi bi-house-door-fill me-1" 
                                               :class="txn.payerType === 'Tenant' ? 'text-warning' : 'text-success'"></i> 
                                            
                                            <!-- Flat Number First -->
                                            <span class="fw-bold">Flat <span x-text="txn.displayFlat"></span></span>
                                            
                                            <!-- Separator & Name (If Known) -->
                                            <span x-show="txn.displayResidentName !== 'Unknown'" class="d-flex align-items-center">
                                                <span class="mx-1">-</span>
                                                <span x-text="txn.displayResidentName"></span>
                                            </span>

                                            <!-- Payer Badge -->
                                            <span class="badge rounded-pill border ms-2" 
                                                  :class="txn.payerType === 'Tenant' ? 'bg-warning bg-opacity-10 text-warning border-warning' : 'bg-success bg-opacity-10 text-success border-success'"
                                                  style="font-size: 0.6rem; text-transform: uppercase;"
                                                  x-text="txn.payerType">
                                            </span>
                                        </div>
                                        
                                        <!-- Line 3: Date -->
                                        <div class="text-muted small mt-1 d-flex align-items-center">
                                            <i class="bi bi-clock-fill me-1 text-primary"></i>
                                            <span x-text="txn.fullDateTime"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <div class="fw-bold text-success fs-6" x-text="'+ ₹' + txn.amount"></div>
                                    <div class="mt-1">
                                        <span class="badge rounded-pill" 
                                              :class="txn.status.toLowerCase() === 'paid' ? 'bg-success' : 'bg-warning text-dark'" 
                                              style="font-size: 0.6rem;" x-text="txn.status"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <template x-if="dashboardStats.recentTransactions.length === 0">
                        <div class="p-4 text-center text-muted small">
                            No recent transactions found
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</template>