<!-- Header -->
<div class="px-3 pt-4 pb-2 d-flex align-items-center sticky-top bg-white border-bottom shadow-sm" style="z-index: 1020;">
    <button class="btn btn-light rounded-circle p-2 me-3" @click="view = 'residents'; txnSuccess = false;">
        <i class="bi bi-arrow-left fs-5"></i>
    </button>
    <h5 class="fw-bold mb-0">Record Payment</h5>
</div>

<div class="p-3 pb-5 bg-light min-vh-100">
    
    <!-- 1. SUCCESS STATE VIEW -->
    <template x-if="txnSuccess">
        <div class="d-flex flex-column align-items-center justify-content-center text-center pt-5 mt-4 page-animate">
            <div class="mb-4 bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                <i class="bi bi-check-lg text-success" style="font-size: 4rem;"></i>
            </div>
            
            <h3 class="fw-bold text-dark mb-2">Saved Successfully!</h3>
            <p class="text-muted mb-5 px-4">The payment has been recorded and is pending validation.</p>

            <div class="w-100 px-2 d-flex flex-column gap-3">
                <button class="btn btn-primary btn-lg rounded-pill py-3 fw-bold shadow-sm" @click="resetTxnForm()">
                    <i class="bi bi-plus-lg me-2"></i> Add New Entry
                </button>
                
                <button class="btn btn-white btn-lg rounded-pill py-3 fw-bold border shadow-sm text-muted" @click="view = 'residents'; txnSuccess = false;">
                    Close Form
                </button>
            </div>
        </div>
    </template>


    <!-- 2. FORM STATE VIEW -->
    <!-- FIX: Changed x-show to template x-if. 
         This removes the element from DOM entirely when successful, 
         fixing the Bootstrap 'd-flex !important' display conflict. -->
    <template x-if="!txnSuccess">
        <div class="d-flex flex-column gap-3">
            
            <!-- HERO AMOUNT INPUT -->
            <div class="card border-0 shadow-sm rounded-4 mb-2 overflow-hidden">
                <div class="card-body p-4 text-center bg-white">
                    <label class="text-uppercase fw-bold text-muted small mb-2" style="letter-spacing: 1px;">Amount Received</label>
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="display-3 fw-bold text-success me-1">â‚¹</span>
                        <input type="number" x-model="txnForm.amount" 
                               class="form-control border-0 p-0 display-1 fw-bold text-center text-dark bg-transparent" 
                               placeholder="0" 
                               style="max-width: 250px; outline: none; box-shadow: none;">
                    </div>
                </div>
            </div>

            <!-- FLAT SELECTION -->
            <div>
                <label class="form-label small fw-bold text-muted ms-1">Resident / Flat</label>
                <div class="card border-0 shadow-sm rounded-4">
                    <select x-model="txnForm.flatNo" class="form-select border-0 py-3 rounded-4 fw-bold" style="background-color: white;">
                        <option value="" disabled selected>Select Flat...</option>
                        <template x-for="r in residents" :key="r.flat">
                            <option :value="r.flat">
                                <span x-text="r.flat"></span> - 
                                <span x-text="r.occupants.length > 0 ? r.occupants[0].name : 'Unknown'"></span>
                            </option>
                        </template>
                    </select>
                </div>
            </div>

            <!-- CATEGORY TOGGLE (Radio Style) -->
            <div>
                <label class="form-label small fw-bold text-muted ms-1">Payment Category</label>
                <div class="bg-white p-1 rounded-4 border shadow-sm d-flex">
                    <button class="btn flex-fill rounded-4 py-2 fw-bold transition-all"
                            :class="txnForm.category === 'Monthly' ? 'bg-primary text-white shadow-sm' : 'text-muted'"
                            @click="txnForm.category = 'Monthly'">
                        Monthly
                    </button>
                    <button class="btn flex-fill rounded-4 py-2 fw-bold transition-all"
                            :class="txnForm.category === 'Adhoc' ? 'bg-warning text-dark shadow-sm' : 'text-muted'"
                            @click="txnForm.category = 'Adhoc'">
                        Adhoc / Other
                    </button>
                </div>
            </div>

            <!-- MONTH & TITLE LOGIC -->
            <div class="row g-3">
                <!-- Month Picker -->
                <div class="col-12">
                    <label class="form-label small fw-bold text-muted ms-1">For Month</label>
                    <input type="month" x-model="txnForm.month" class="form-control border-0 shadow-sm rounded-4 py-3 bg-white fw-bold">
                </div>

                <!-- Conditional Title (Only for Adhoc) -->
                <div class="col-12" x-show="txnForm.category === 'Adhoc'" x-transition>
                    <label class="form-label small fw-bold text-muted ms-1">Title / Purpose</label>
                    <input type="text" x-model="txnForm.title" class="form-control border-0 shadow-sm rounded-4 py-3 bg-white" placeholder="e.g. Diwali Donation">
                </div>
            </div>

            <!-- DATE & TIME -->
            <div>
                <label class="form-label small fw-bold text-muted ms-1">Payment Date & Time</label>
                <input type="datetime-local" x-model="txnForm.paymentDate" class="form-control border-0 shadow-sm rounded-4 py-3 bg-white">
            </div>

            <!-- PAYMENT METHOD -->
            <div>
                <label class="form-label small fw-bold text-muted ms-1">Method</label>
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <select x-model="txnForm.method" class="form-select border-0 py-3 ps-3 bg-white">
                        <option value="UPI">UPI / GPay / Paytm</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer / NEFT</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
            </div>

            <!-- REMARKS -->
            <div>
                <label class="form-label small fw-bold text-muted ms-1">Remarks</label>
                <textarea x-model="txnForm.remarks" class="form-control border-0 shadow-sm rounded-4 p-3 bg-white" rows="2" placeholder="Any additional notes..."></textarea>
            </div>

            <!-- SUBMIT BUTTON -->
            <div class="pt-2 pb-4">
                <button class="btn btn-primary btn-lg w-100 rounded-pill py-3 fw-bold shadow-lg d-flex align-items-center justify-content-center gap-2"
                        :disabled="isSubmitting || !txnForm.amount || !txnForm.flatNo"
                        @click="saveTransaction">
                    
                    <span x-show="!isSubmitting"><i class="bi bi-check-lg"></i> Save Record</span>
                    
                    <span x-show="isSubmitting">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Saving...
                    </span>
                </button>
            </div>

        </div>
    </template>

</div>